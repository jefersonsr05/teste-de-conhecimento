unit cCadProdutos;

interface

uses System.Classes, vcl.Controls, vcl.ExtCtrls, vcl.Dialogs,
      ZAbstractConnection, ZConnection, ZAbstractRODataset, ZAbstractDataset, ZDataset, System.SysUtils;

type
  TProduto = class

  private
    { Private declarations }

    ConexaoDB:TZConnection;

    _fCodigo:integer;
    _fDescricao:string;
    _fReferencia:string;
    _fUnidade:string;
    _fDataVenda:TDateTime;
    _fPreco:double;
    _fSaldo:double;
    function PrimeiroCodigo: boolean;

  public
    { Public declarations }
    constructor Create(_Conexao:TZConnection);
    destructor Destroy; override;
    function Inserir:boolean;
    function Atualizar:boolean;
    function Apagar:boolean;
    function Selecionar(id:Integer):boolean;

  published
    { Public declarations properties/runtime }
    property codigo:integer         read _fCodigo        write _fCodigo;
    property descricao:string       read _fDescricao     write _fDescricao;
    property referencia:string      read _fReferencia    write _fReferencia;
    property unidade:string         read _fUnidade       write _fUnidade;
    property datavenda:TDateTime    read _fDataVenda     write _fDataVenda;
    property preco:double           read _fPreco         write _fPreco;
    property saldo:double           read _fSaldo         write _fSaldo;
  end;

implementation

{ TProduto }

{$region 'CONSTRUCTOR AND DESTRUCTOR'}

constructor TProduto.Create(_Conexao: TZConnection);
begin
  ConexaoDB := _Conexao;
end;

destructor TProduto.Destroy;
begin

  inherited;
end;

{$endregion}

{$region 'CRUD'}

function TProduto.Inserir: boolean;
var qry : TZQuery;
begin
  try
    result := true;
    qry := TZQuery.Create(nil);
    qry.Connection := ConexaoDB;
    qry.SQL.Clear; //Limpar possiveis sujeiras na memoria.
    if (PrimeiroCodigo) then
    begin
      qry.SQL.Add('INSERT INTO CLIENTE VALUES (1,'+
                    ':descricao,:referencia,:unidade,:datavenda,:precovenda,:saldo)');
      qry.ParamByName('descricao').Value := self._fDescricao;
      qry.ParamByName('referencia').Value := self._fReferencia;
      qry.ParamByName('unidade').Value := self._fUnidade;
      qry.ParamByName('datavenda').Value := self._fDataVenda;
      qry.ParamByName('precovenda').Value := self._fPreco;
      qry.ParamByName('saldo').Value := self._fSaldo;
      try
        qry.ExecSQL;
      except
        result := false;
      end;
    end
    else
      begin
      qry.SQL.Add('INSERT INTO CLIENTE VALUES ((SELECT max(codigo) FROM produtos)+1,'+
                    ':descricao,:referencia,:unidade,:datavenda,:precovenda,:saldo)');
      qry.ParamByName('descricao').Value := self._fDescricao;
      qry.ParamByName('referencia').Value := self._fReferencia;
      qry.ParamByName('unidade').Value := self._fUnidade;
      qry.ParamByName('datavenda').Value := self._fDataVenda;
      qry.ParamByName('precovenda').Value := self._fPreco;
      qry.ParamByName('saldo').Value := self._fSaldo;
      try
        qry.ExecSQL;
      except
        result := false;
      end;
    end;
  finally
    if Assigned(qry) then
      FreeAndNil(qry);
  end;
end;

function TProduto.PrimeiroCodigo: boolean;
var qry :TZQuery;
begin
  try
    result := true;
    qry := TZQuery.Create(nil);
    qry.Connection := ConexaoDB;
    qry.SQL.Clear; //Limpar possiveis sujeiras na memoria.
    qry.SQL.Add('select codigo from cliente');
      try
        qry.Open;

        if qry.FieldByName('codigo').AsString = '' then
          result := true
        else
          result := false;
      except
        result := false;
      end;
  finally
    if Assigned(qry) then
      FreeAndNil(qry);
  end;
end;

function TProduto.Selecionar(Id: Integer): boolean;
var qry : TZQuery;
begin
  try
    result := true;
    qry := TZQuery.Create(nil);
    qry.Connection := ConexaoDB;
    qry.SQL.Clear;
    qry.SQL.Add('select codigo,nome,endereco,bairro,cidade,cep,uf,fone,celular,email from cliente where codigo=:codigo');
    qry.ParamByName('codigo').Value:=Id;
    try
      qry.Open;

      self._fCodigo := qry.FieldByName('codigo').AsInteger;
      self._fNome := qry.FieldByName('nome').AsString;
      SELF._fEndereco := qry.FieldByName('endereco').AsString;
      self._fBairro := qry.FieldByName('bairro').AsString;
      self._fCidade := qry.FieldByName('cidade').AsString;
      self._fCep := qry.FieldByName('cep').AsString;
      self._fUf := qry.FieldByName('uf').AsString;
      self._fFone := qry.FieldByName('fone').AsString;
      self._fCelular := qry.FieldByName('celular').AsString;
      self._fEmail := qry.FieldByName('email').AsString;
    except
      result := false;
    end;
  finally
    if Assigned(qry) then
      FreeAndNil(qry);
end;
end;

function TProduto.Apagar: boolean;
var qry : TZQuery;
begin
  if MessageDlg('Apagar o cliente '+_fNome,mtConfirmation,[mbYes,mbNo], 0) = mrNo then
  begin
    result := false;
    abort;
  end;

  try
    result := true;
    qry := TZQuery.Create(nil);
    qry.Connection := ConexaoDB;
    qry.SQL.Clear;
    qry.SQL.Add('delete from cliente where codigo=:codigo');
    qry.ParamByName('codigo').AsInteger := _fCodigo;
    try
      qry.ExecSQL;
    except
      result := false;
    end;

  finally
    if Assigned(qry) then
      FreeAndNil(qry);
  end;


end;

function TProduto.Atualizar: boolean;
var qry : TZQuery;
begin
  try
    result := true;
    qry := TZQuery.Create(nil);
    qry.Connection := ConexaoDB;
    qry.SQL.Clear;
    qry.SQL.Add('update cliente' +
                ' set nome=:nome ' +
                ',endereco=:endereco' +
                ',bairro=:bairro' +
                ',cidade=:cidade' +
                ',cep=:cep' +
                ',uf=:uf' +
                ',fone=:fone' +
                ',celular=:celular' +
                ',email=:email ' +
                ' where codigo=:codigo');
    qry.ParamByName('codigo').Value := self._fCodigo;
    qry.ParamByName('nome').Value := self._fNome;
    qry.ParamByName('endereco').value := self._fEndereco;
    qry.ParamByName('bairro').value := self._fBairro;
    qry.ParamByName('cidade').value := self._fCidade;
    qry.ParamByName('cep').Value := self._fCep;
    qry.ParamByName('uf').Value := self._fUf;
    qry.ParamByName('fone').Value := self._fFone;
    qry.ParamByName('celular').Value := self._fCelular;
    qry.ParamByName('email').Value := self._fEmail;
    try
      qry.ExecSQL;
    except
      result := false;
    end;
  finally
  end;
end;

{$endregion}

end.
